# Nextcloud User Files Backup

## Конфигурация

Home Assistant OS не предоставляет прямого доступа к USB-накопителям.
Для использования внешних дисков их необходимо заранее примонтировать в систему
и присвоить разделам уникальные метки файловой системы.
Метки используются аддоном для идентификации устройств.

## Подготовка системы

Для настройки монтирования дисков требуется доступ к системе Home Assistant
OS по SSH.

[![Developer docs – Home Assistant OS Debugging](https://img.shields.io/badge/Developer%20docs-Home%20Assistant-blue?logo=home-assistant&logoColor=white&labelColor=41B3A3)](https://developers.home-assistant.io/docs/operating-system/debugging)

После получения доступа:

1. Подключите внешний диск.
2. Присвойте разделу метку файловой системы.
3. Настройте автоматическое монтирование по метке.

Пример назначения метки разделу:

```bash

  e2label /dev/sdb2 NC_backup
```

Для автоматического монтирования дисков автор использует решение на основе
[udev](https://gist.github.com/microraptor/be170ea642abeb937fc030175ae89c0c).
Автор решения: [microraptor](https://gist.github.com/microraptor).  
Настройте правило монтирования в соответствии с инструкцией.

---

## Параметры конфигурации

### Общие настройки

- **Часовой пояс (`timezone`)**  
  Часовой пояс, используемый аддоном для планирования заданий и логирования.

- **Расписание (`schedule`)**  
  Расписание запуска резервного копирования в формате cron  
  (минуты, часы, день месяца, месяц, день недели).

- **Параметры rsync (`rsync_options`)**  
  Параметры, передаваемые утилите `rsync` при выполнении резервного копирования.  
  Используются для управления режимом копирования и синхронизации файлов.

- **Тестовый режим (`test_mode`)**  
  При включении выполняется симуляция резервного копирования без фактического  
  копирования данных.  
  Используется для проверки конфигурации и логики работы аддона.

### Настройки хранения (`storage`)

- **Базовый путь монтирования (`mount_root`)**  
  Базовый каталог, в котором доступны примонтированные внешние накопители  
  (например: `media`).

- **Метка диска резервных копий (`backup_disk_label`)**  
  Метка файловой системы внешнего диска, используемого для хранения резервных копий.

- **Метка диска с данными (`data_disk_label`)**  
  Метка файловой системы диска, на котором расположены данные Nextcloud.

- **Каталог данных Nextcloud (`nextcloud_data_dir`)**  
  Каталог внутри диска с данными, содержащий пользовательские файлы Nextcloud.

### Управление питанием (`power`)

- **Включить управление питанием (`enabled`)**  
  Включает управление питанием внешнего диска резервного копирования  
  с помощью умного выключателя.

- **Выключатель питания диска (`disk_switch`)**  
  Идентификатор выключателя в Home Assistant **без домена `switch.`**  
  (например: `usb_disk_power`).

> [!WARNING]
> Если управление питанием включено (`enabled: true`),  
> параметр `disk_switch` **обязателен**.  
> При отсутствии выключателя аддон не будет запущен.

### Уведомления (`notifications`)

- **Включить уведомления (`enabled`)**  
  Включает отправку уведомлений о результате выполнения резервного копирования.

- **Сервис уведомлений (`service`)**  
  Сервис Home Assistant для отправки уведомлений **без домена `notify.`**  
  (например: `send_message`, `telegram`).

- **Сообщение об успешном завершении (`success_message`)**  
  Текст уведомления, отправляемого при успешном завершении резервного копирования.

- **Сообщение об ошибке (`error_message`)**  
  Текст уведомления, отправляемого при ошибке выполнения резервного копирования.

> [!WARNING]
> Если уведомления включены (`enabled: true`),  
> параметр `service` **обязателен**.  
> При отсутствии сервиса аддон не будет запущен.

---

## Принцип работы

При запуске аддон выполняет следующие шаги:

1. Включает питание внешнего диска (если включено управление питанием)
2. Монтирует диск резервного копирования
3. Выполняет инкрементное резервное копирование с использованием rsync
4. Отмонтирует диск
5. Отключает питание диска (если включено)
6. Отправляет уведомление о результате выполнения

При запуске аддон инициализирует планировщик cron и ожидает
наступления заданного времени для выполнения резервного копирования.

---

### Тестовый режим

При включённом параметре test_mode аддон не выполняет фактическое копирование данных.
Вместо этого выполняется симуляция всех этапов без изменения файлов.

---

## Частые проблемы

- Backup disk not mounted  
  Проверьте метки файловых систем и правила udev.
- Configuration validation failed  
  Проверьте корректность настроек аддона в пользовательском интерфейсе Home Assistant.
